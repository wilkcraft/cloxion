<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloxion</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f4f8;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        overflow: hidden;
      }

      .login-container,
      .chat-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: 90%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .login-container h2 {
        margin-bottom: 10px;
      }

      .login-container input {
        margin: 10px 0;
        padding: 10px;
        width: 100%;
        border-radius: 5px;
        border: 1px solid #ccc;
        background-color: #fff;
        color: #000;
      }

      .login-container input::placeholder {
        color: #777;
      }

      .login-container button {
        background-color: #00bcd4;
        color: white;
        border: none;
        padding: 10px;
        width: 100%;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .login-container button:hover {
        background-color: #0097a7;
      }

      .chat-container {
        display: none; /* por defecto est√° oculto */
        height: 98vh;
        max-width: 100vw; /* que nunca supere la pantalla */
        margin-left: 0;
        flex-direction: column;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .chat-header {
        background-color: #00bcd4;
        color: white;
        padding: 15px;
        font-weight: bold;
        width: 100%;
      }

      .menu-icon {
        margin-right: 8px;
        cursor: pointer;
        font-size: 22px;
        color: white;
        vertical-align: middle;
      }

      .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        width: 100%;
      }

      .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 18px;
        max-width: 75%;
        word-wrap: break-word;
        position: relative;
        user-select: none;
      }

      .message.sent {
        background-color: #e0ffff;
        align-self: flex-end;
        margin-left: auto;
      }

      .message.received {
        background-color: #fffacd;
        align-self: flex-start;
        margin-right: auto;
      }

      .chat-input {
        display: flex;
        padding: 10px;
        width: 100%;
        background-color: #e9ecef;
      }

      .chat-input input {
        flex-grow: 1;
        border: none;
        border-radius: 20px;
        padding: 10px;
        outline: none;
      }

      .chat-input button {
        background-color: #00bcd4;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      .context-menu {
        position: absolute;
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        padding: 5px;
        display: flex;
        flex-direction: column;
        min-width: 110px;
        animation: fadeIn 0.1s ease-out;
      }

      .context-menu button {
        background: none;
        border: none;
        text-align: left;
        padding: 8px 12px;
        width: 100%;
        cursor: pointer;
        font-size: 14px;
        color: #333;
      }

      .context-menu button:hover {
        background: #f2f2f2;
      }

      .user-list {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 220px;
        background: #ffffff;
        border-right: 1px solid #e0e0e0;
        box-shadow: 2px 0 6px rgba(0, 0, 0, 0.05);
        padding: 15px 0;
        display: flex;
        flex-direction: column;
        z-index: 50;
      }

      .user-list strong {
        text-align: center;
        font-size: 18px;
        color: #00bcd4;
        margin-bottom: 15px;
        display: block;
        font-weight: bold;
        letter-spacing: 0.5px;
      }

      .user-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        margin: 3px 8px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.1s ease;
      }

      .user-item:hover {
        background: #e0f7fa;
        transform: translateX(2px);
      }

      .user-item.active {
        background: #b2ebf2;
        font-weight: bold;
      }

      .user-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #00bcd4;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 16px;
        box-shadow: 0 2px 4px rgba(0, 188, 212, 0.3);
      }

      .admin-item {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        margin: 6px 8px;
      }

      .admin-item:hover {
        background: #bbdefb;
      }

      .message-time {
        display: block;
        font-size: 11px;
        color: #555;
        text-align: right;
        margin-top: 3px;
      }

      .date-separator {
        text-align: center;
        margin: 15px 0;
        color: #777;
        font-weight: bold;
        font-size: 13px;
        position: relative;
      }

      .date-separator::before,
      .date-separator::after {
        content: "";
        position: absolute;
        top: 50%;
        width: 35%;
        height: 1px;
        background: #ccc;
      }

      .date-separator::before {
        left: 0;
      }

      .date-separator::after {
        right: 0;
      }

      /* üü¶ Recuadro de inicio de chat */
      .chat-start {
        text-align: center;
        background: #d1ecf1;
        color: #0c5460;
        padding: 8px 12px;
        border-radius: 10px;
        margin: 10px auto;
        width: fit-content;
        max-width: 80%;
        font-size: 14px;
        font-weight: 600;
        font-family: Arial, sans-serif;
      }

      #toggle-user-list {
        display: none;
      }

      @media (min-width: 769px) {
        .chat-container {
          margin-left: 220px; /* ancho de .user-list */
          max-width: calc(100vw - 220px); /* no sobresalir de la pantalla */
        }

        #toggle-user-list {
          display: none !important; /* Ocultamos el bot√≥n flotante */
        }
      }

      /* Ocultar la lista de usuarios en m√≥vil */
      @media (max-width: 768px) {
        .chat-container {
          margin-left: 0;
          max-width: 100vw;
          width: 100%;
        }

        .user-list {
          display: none;
          position: fixed;
          left: 0;
          top: 0;
          height: 100%;
          z-index: 100;
          background: #ffffff;
          box-shadow: 2px 0 6px rgba(0, 0, 0, 0.2);
          transition: transform 0.3s ease;
          transform: translateX(-100%);
        }

        .user-list.show {
          transform: translateX(0);
          display: flex;
        }

        /* Bot√≥n para abrir/cerrar men√∫ */
        #toggle-user-list {
          display: none !important; /* Ocultamos el bot√≥n flotante */
        }

        .chat-input {
          bottom: 0; /* ‚úÖ evita que se esconda */
        }
      }

      /* üåô MODO OSCURO */
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #121212;
          color: white;
        }

        .login-container {
          background-color: #1e1e1e;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .login-container input {
          background-color: #2b2b2b;
          border: 1px solid #444;
          color: white;
        }

        .login-container input::placeholder {
          color: #b0b0b0;
        }

        .login-container button {
          background-color: #00838f;
        }

        .login-container button:hover {
          background-color: #00acc1;
        }

        .chat-container {
          background-color: #1e1e1e;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .chat-messages {
          background-color: #1e1e1e;
        }

        .chat-header {
          background-color: #00838f;
        }

        .message.sent {
          background-color: #00796b;
        }

        .message.received {
          background-color: #bbaa55;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .chat-input {
          background-color: #2c2c2c;
        }

        .chat-input input {
          background-color: #3a3a3a;
          color: #ffffff;
        }

        .chat-input input::placeholder {
          color: #b0b0b0;
        }

        .chat-input button {
          background-color: #00838f;
        }

        .context-menu {
          background: #2b2b2b;
          border: 1px solid #555;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .context-menu button {
          color: #ddd;
        }

        .context-menu button:hover {
          background: #3a3a3a;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(-5px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .user-list {
          background: #1e1e1e;
          border-right: 1px solid #333;
          box-shadow: 2px 0 6px rgba(255, 255, 255, 0.05);
        }

        .user-list strong {
          color: #00acc1;
        }

        .user-item {
          color: #ddd;
        }

        .user-item:hover {
          background: #004d40;
        }

        .user-item.active {
          background: #00695c;
          font-weight: bold;
        }

        .user-avatar {
          background: #00acc1;
          color: #fff;
          box-shadow: 0 2px 4px rgba(0, 172, 193, 0.4);
        }

        .admin-item {
          background: #003c4f;
          border: 1px solid #00838f;
        }

        .admin-item:hover {
          background: #004d61;
        }

        .message-time {
          color: #bbb;
        }
        .date-separator {
          color: #ccc;
        }
        .date-separator::before,
        .date-separator::after {
          background: #555;
        }

        /* üîµ Contador de mensajes no le√≠dos */
        .unread-badge {
          background-color: #ff3b30;
          color: white;
          border-radius: 50%;
          padding: 2px 6px;
          font-size: 12px;
          font-weight: bold;
          margin-left: auto;
          display: none;
        }

        .chat-start {
          background: #004d61;
          color: #b2ebf2;
        }
      }
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <div class="login-container" id="login-container">
      <h2>Iniciar sesi√≥n</h2>
      <input type="text" id="username" placeholder="Usuario" />
      <input type="password" id="password" placeholder="Contrase√±a" />
      <button onclick="login()">Entrar</button>
      <p id="login-error" style="color: red; display: none">
        Usuario o contrase√±a incorrectos
      </p>
    </div>

    <!-- CHAT -->
    <div class="chat-container" id="chat-container">
      <button id="toggle-user-list">‚ò∞</button>
      <div class="user-list" id="user-list"></div>
      <div class="chat-header" id="chat-header">Chat</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input">
        <input
          type="text"
          id="message-input"
          placeholder="Escribe un mensaje..."
        />
        <button onclick="sendMessage()">‚û§</button>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        addDoc,
        deleteDoc,
        onSnapshot,
        query,
        where, // üëà A√±ade esta l√≠nea
        orderBy,
        getDocs,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDLKdKtSocG9hLs8mSggXl0cL4MRcpsW5A",
        authDomain: "iniciosesion-1346.firebaseapp.com",
        projectId: "iniciosesion-1346",
        storageBucket: "iniciosesion-1346.firebasestorage.app",
        messagingSenderId: "746485966333",
        appId: "1:746485966333:web:cbd2b68649a72e936ca594",
        measurementId: "G-ZVE389BCKD",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      let currentUser = sessionStorage.getItem("currentUser") || null;
      let activeChatId = null;
      let activeChatWith = null;

      async function login() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorMsg = document.getElementById("login-error");

        const userRef = doc(db, "usuarios", username);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          if (username === "Miguel" && password === "1346") {
            await setDoc(userRef, { nombre: "Miguel", password: "1346" });
          } else {
            errorMsg.style.display = "block";
            return;
          }
        }

        const userData = (await getDoc(userRef)).data();

        if (userData.password === password) {
          currentUser = username;
          sessionStorage.setItem("currentUser", username); // ‚úÖ Guardar sesi√≥n temporal

          document.getElementById("login-container").style.display = "none";
          document.getElementById("chat-container").style.display = "flex";

          await loadUserList();
          listenForIncomingMessages();

          activeChatWith = "Admin";
          activeChatId = `${currentUser}_admin`;
          updateChatHeader(`${currentUser} (T√∫)`);
          loadMessages(activeChatId);

          sessionStorage.setItem("lastChatWith", "Admin"); // üü© Guardar si est√° en su propio chat

          const adminItem = document.querySelector(".admin-item");
          if (adminItem) adminItem.classList.add("active");
        } else {
          errorMsg.style.display = "block";
        }
      }

      function getChatId(user1, user2) {
        return [user1, user2].sort().join("_");
      }

      // --- üëÇ Escuchar todos los chats donde participa el usuario ---
      function listenForIncomingMessages() {
        const usersRef = collection(db, "usuarios");

        getDocs(usersRef).then((snapshot) => {
          snapshot.forEach((userDoc) => {
            const user = userDoc.data().nombre;
            if (user === currentUser) return;

            const chatId = getChatId(currentUser, user);
            const q = query(
              collection(db, "chatsPrivados", chatId, "mensajes"),
              where("timestamp", "!=", null),
              orderBy("timestamp")
            );

            onSnapshot(q, (snap) => {
              let unreadCount = 0;
              snap.forEach((msgDoc) => {
                const msg = msgDoc.data();
                if (
                  msg.usuario !== currentUser &&
                  msg.check !== true &&
                  activeChatWith !== user
                ) {
                  unreadCount++;
                }
              });
              updateUnreadBadge(user, unreadCount);
            });
          });
        });
      }

      async function loadUserList() {
        const userList = document.getElementById("user-list");
        userList.innerHTML = "<strong>Usuarios</strong>";

        // üîπ Crear el usuario "Admin (T√∫)"
        const adminDiv = document.createElement("div");
        adminDiv.classList.add("user-item", "admin-item");
        adminDiv.dataset.name = currentUser; // ‚úÖ Guardar el nombre real del usuario

        const adminAvatar = document.createElement("div");
        adminAvatar.classList.add("user-avatar");
        adminAvatar.textContent = "üß†";

        const adminName = document.createElement("span");
        adminName.textContent = `${currentUser} (T√∫)`;

        adminDiv.appendChild(adminAvatar);
        adminDiv.appendChild(adminName);

        adminDiv.onclick = () => {
          document
            .querySelectorAll(".user-item")
            .forEach((el) => el.classList.remove("active"));
          adminDiv.classList.add("active");

          // Chat personal del admin
          activeChatWith = "Admin";
          activeChatId = `${currentUser}_admin`;

          updateChatHeader(`${currentUser} (T√∫)`);
          loadMessages(activeChatId);

          closeMenuOnMobile(); // üëà cerrar men√∫ al hacer clic
        };

        userList.appendChild(adminDiv);

        // üîπ Cargar el resto de usuarios normales
        const usersSnap = await getDocs(collection(db, "usuarios"));
        usersSnap.forEach((u) => {
          const data = u.data();
          if (data.nombre !== currentUser) {
            const div = document.createElement("div");
            div.classList.add("user-item");
            div.dataset.name = data.nombre; // ‚úÖ Guardar el nombre del usuario

            const avatar = document.createElement("div");
            avatar.classList.add("user-avatar");
            avatar.textContent = data.nombre.charAt(0).toUpperCase();

            const name = document.createElement("span");
            name.textContent = data.nombre;

            div.appendChild(avatar);
            div.appendChild(name);

            // üîπ A√±adir el c√≠rculo de mensajes no le√≠dos
            const badge = document.createElement("span");
            badge.classList.add("unread-badge");
            badge.id = `badge_${data.nombre}`;
            badge.textContent = "0";
            div.appendChild(badge);

            div.onclick = () => {
              document
                .querySelectorAll(".user-item")
                .forEach((el) => el.classList.remove("active"));
              div.classList.add("active");
              openPrivateChat(data.nombre);
              closeMenuOnMobile(); // üëà cerrar men√∫ al hacer clic
            };

            userList.appendChild(div);
          }
        });
      }

      // --- üîî Control de mensajes no le√≠dos ---
      function updateUnreadBadge(user, count) {
        const badge = document.getElementById(`badge_${user}`);
        if (!badge) return;
        if (count > 0) {
          badge.style.display = "inline-block";
          badge.textContent = count;
        } else {
          badge.style.display = "none";
        }
      }

      async function openPrivateChat(otherUser) {
        const messagesContainer = document.getElementById("chat-messages");
        messagesContainer.innerHTML = "";
        activeChatWith = otherUser;
        // ‚úÖ Marcar visualmente el contacto activo
        document
          .querySelectorAll(".user-item")
          .forEach((el) => el.classList.remove("active"));
        const currentDiv = [...document.querySelectorAll(".user-item")].find(
          (d) => d.dataset.name === otherUser
        );
        if (currentDiv) currentDiv.classList.add("active");

        activeChatId = getChatId(currentUser, otherUser);

        updateChatHeader(`${otherUser}`);
        loadMessages(activeChatId);
        updateUnreadBadge(otherUser, 0);

        // üü© Marcar como le√≠dos los mensajes recibidos
        const chatRef = collection(
          db,
          "chatsPrivados",
          activeChatId,
          "mensajes"
        );
        const mensajesSnap = await getDocs(chatRef);

        mensajesSnap.forEach(async (msgDoc) => {
          const msg = msgDoc.data();
          if (msg.usuario !== currentUser && msg.check !== true) {
            await setDoc(msgDoc.ref, { check: true }, { merge: true });
          }
        });

        sessionStorage.setItem("lastChatWith", otherUser); // üü© Guardar contacto activo
      }

      // --- Helper para normalizar timestamps ---
      function parseTimestamp(ts) {
        if (!ts) return new Date();

        // Si ya es un objeto Firestore Timestamp
        if (typeof ts.toDate === "function") return ts.toDate();

        // Si es un string tipo "31 de octubre de 2025, 6:53:57 p.m. UTC+1"
        if (typeof ts === "string") {
          // Intentar convertirlo a fecha con Date.parse no funcionar√° siempre, as√≠ que lo forzamos:
          try {
            // Eliminamos caracteres raros como el " " (espacio fino)
            const limpio = ts.replace(/\u202f/g, " ").replace(" ", " ");
            const fecha = new Date(limpio);
            if (!isNaN(fecha.getTime())) return fecha;
          } catch (e) {}
        }

        // Si nada funcion√≥, usar fecha actual
        return new Date();
      }

      function loadMessages(chatId) {
        const messagesContainer = document.getElementById("chat-messages");
        messagesContainer.innerHTML = "";

        const q = query(
          collection(db, "chatsPrivados", chatId, "mensajes"),
          where("timestamp", "!=", null),
          orderBy("timestamp")
        );

        // üü© Restaurar scroll si existe
        const savedScroll = sessionStorage.getItem(`scroll_${chatId}`);
        if (savedScroll) {
          setTimeout(() => {
            messagesContainer.scrollTop = parseInt(savedScroll);
          }, 200);
        }

        // üü© Guardar posici√≥n del scroll en tiempo real
        messagesContainer.addEventListener("scroll", () => {
          sessionStorage.setItem(
            `scroll_${chatId}`,
            messagesContainer.scrollTop
          );
        });

        onSnapshot(q, (snapshot) => {
          messagesContainer.innerHTML = "";
          let firstSender = null;

          const ocultosKey = `${currentUser}_ocultos_${chatId}`;
          const mensajesOcultos = JSON.parse(
            localStorage.getItem(ocultosKey) || "[]"
          );

          let lastDate = null; // üïì para saber cu√°ndo insertar separadores

          snapshot.forEach((docSnap) => {
            const msg = docSnap.data();
            const msgId = docSnap.id;

            if (!firstSender && msg.usuario) {
              firstSender = msg.usuario;
            }

            if (mensajesOcultos.includes(msgId)) return;

            // üî∏ Esperar hasta que Firestore tenga timestamp real
            if (!msg.timestamp) return; // si a√∫n es null, lo saltamos por ahora

            const msgDate = parseTimestamp(msg.timestamp);
            const fechaMostrar = msg.fechaTexto || msg.timestamp;

            // --- Separador de fecha ---
            const msgDayKey = msgDate.toDateString();
            if (msgDayKey !== lastDate) {
              lastDate = msgDayKey;
              const separator = document.createElement("div");
              separator.classList.add("date-separator");
              separator.textContent = getDateLabel(msgDate);
              messagesContainer.appendChild(separator);
            }

            // --- Mensaje ---
            const messageElement = document.createElement("div");
            messageElement.classList.add(
              "message",
              msg.usuario === currentUser ? "sent" : "received"
            );
            messageElement.dataset.id = msgId;

            // Contenido del mensaje + hora
            const textSpan = document.createElement("span");
            textSpan.textContent = msg.texto;

            const timeSpan = document.createElement("span");
            timeSpan.classList.add("message-time");
            timeSpan.textContent =
              typeof fechaMostrar === "string"
                ? fechaMostrar.split(",")[1]?.trim()?.slice(0, 5) ||
                  formatTime(msgDate)
                : formatTime(msgDate);

            messageElement.appendChild(textSpan);
            messageElement.appendChild(timeSpan);

            // --- Men√∫ contextual eliminar ---
            messageElement.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              const oldMenu = document.querySelector(".context-menu");
              if (oldMenu) oldMenu.remove();

              const menu = document.createElement("div");
              menu.classList.add("context-menu");
              menu.innerHTML = `<button class="menu-delete">üóëÔ∏è Eliminar</button>`;
              document.body.appendChild(menu);

              const rect = messageElement.getBoundingClientRect();
              menu.style.top = `${rect.bottom + window.scrollY - 10}px`;
              menu.style.left = `${
                rect.right + window.scrollX - menu.offsetWidth - 10
              }px`;

              menu
                .querySelector(".menu-delete")
                .addEventListener("click", async () => {
                  menu.remove();

                  if (msg.usuario === currentUser) {
                    await deleteDoc(
                      doc(db, "chatsPrivados", chatId, "mensajes", msgId)
                    );
                  } else {
                    const nuevosOcultos = [...mensajesOcultos, msgId];
                    localStorage.setItem(
                      ocultosKey,
                      JSON.stringify(nuevosOcultos)
                    );
                    messageElement.remove();
                  }
                });

              document.addEventListener(
                "click",
                (ev) => {
                  if (!menu.contains(ev.target)) menu.remove();
                },
                { once: true }
              );
            });

            messagesContainer.appendChild(messageElement);
          });

          // üü¶ Mostrar recuadro de inicio del chat si hay mensajes
          if (firstSender) {
            const startBox = document.createElement("div");
            startBox.classList.add("chat-start");
            startBox.textContent = `Chat comenzado por: ${firstSender}`;

            // Insertarlo al principio del contenedor
            if (messagesContainer.firstChild) {
              messagesContainer.insertBefore(
                startBox,
                messagesContainer.firstChild
              );
            } else {
              messagesContainer.appendChild(startBox);
            }
          }

          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
      }

      // üî∏ Formato de hora: hh:mm
      function formatTime(date) {
        const hours = date.getHours().toString().padStart(2, "0");
        const minutes = date.getMinutes().toString().padStart(2, "0");
        return `${hours}:${minutes}`;
      }

      // üî∏ Texto de fecha: "Hoy", "Ayer" o "23 Octubre 2025"
      function getDateLabel(date) {
        const now = new Date();
        const diffDays = Math.floor(
          (now.setHours(0, 0, 0, 0) - date.setHours(0, 0, 0, 0)) / 86400000
        );

        if (diffDays === 0) return "Hoy";
        if (diffDays === 1) return "Ayer";

        const meses = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];
        return `${date.getDate()} ${
          meses[date.getMonth()]
        } ${date.getFullYear()}`;
      }

      async function sendMessage() {
        const messageInput = document.getElementById("message-input");
        const text = messageInput.value.trim();
        if (!text || !currentUser || !activeChatId) return;

        messageInput.value = "";

        const fecha = new Date();
        const fechaLegible = fecha.toLocaleString("es-ES", {
          dateStyle: "long",
          timeStyle: "medium",
        });

        const messageData = {
          texto: text,
          usuario: currentUser,
          timestamp: serverTimestamp(),
          fechaTexto: fechaLegible,
          check: false,
        };

        // --- Mostrar mensaje localmente al instante
        const messagesContainer = document.getElementById("chat-messages");
        const tempMessage = document.createElement("div");
        tempMessage.classList.add("message", "sent");
        tempMessage.innerHTML = `
    <span>${text}</span>
    <span class="message-time">${fechaLegible
      .split(",")[1]
      ?.trim()
      ?.slice(0, 5)}</span>
  `;
        messagesContainer.appendChild(tempMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const chatRef = doc(db, "chatsPrivados", activeChatId);
        const chatSnap = await getDoc(chatRef);
        if (!chatSnap.exists()) {
          await setDoc(chatRef, {
            participantes: [currentUser, activeChatWith],
            creado: new Date().toISOString(),
          });
        }

        console.log("üì© Enviando a:", activeChatId);

        // --- Guardar en Firestore
        await addDoc(
          collection(db, "chatsPrivados", activeChatId, "mensajes"),
          messageData
        );
      }

      // enter = enviar
      window.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const loginVisible =
            document.getElementById("login-container").style.display !== "none";
          if (loginVisible) login();
          else sendMessage();
        }
      });

      window.addEventListener("load", () => {
        document.querySelectorAll("input").forEach((i) => (i.value = ""));
      });

      // üîπ Funci√≥n para insertar el ‚ò∞ si estamos en m√≥vil
      function ensureMenuIcon() {
        if (window.innerWidth <= 768) {
          if (!chatHeader.querySelector(".menu-icon")) {
            const menuIcon = document.createElement("span");
            menuIcon.textContent = "‚ò∞";
            menuIcon.classList.add("menu-icon");
            chatHeader.prepend(menuIcon);

            menuIcon.addEventListener("click", () => {
              userList.classList.toggle("show");
            });
          }
        } else {
          // Si volvemos a escritorio, quitar el icono
          const icon = chatHeader.querySelector(".menu-icon");
          if (icon) icon.remove();
        }
      }

      // ‚úÖ Mantener sesi√≥n si recargas (estable en m√≥vil y escritorio)
      window.addEventListener("load", async () => {
        document.querySelectorAll("input").forEach((i) => (i.value = ""));

        currentUser = sessionStorage.getItem("currentUser");
        if (!currentUser) return;

        // Mostrar interfaz de chat
        document.getElementById("login-container").style.display = "none";
        document.getElementById("chat-container").style.display = "flex";

        // Aseguramos que el men√∫ est√° cerrado al inicio
        userList.classList.remove("show");

        // Cargamos los usuarios antes de restaurar el chat
        await loadUserList();
        listenForIncomingMessages();

        // Esperamos un poco para asegurar que la lista se renderiza correctamente
        const lastChat = sessionStorage.getItem("lastChatWith") || "Admin";

        const restoreChat = async () => {
          const userItems = document.querySelectorAll(".user-item");
          if (userItems.length === 0) return setTimeout(restoreChat, 100);

          // ‚úÖ Si es un chat con otro usuario
          if (lastChat && lastChat !== "Admin") {
            await openPrivateChat(lastChat);
          } else {
            // ‚úÖ Chat personal del usuario
            activeChatWith = "Admin";
            activeChatId = `${currentUser}_admin`;
            updateChatHeader(`${currentUser} (T√∫)`);
            loadMessages(activeChatId);
            sessionStorage.setItem("lastChatWith", "Admin");
          }

          // ‚úÖ Marcar el contacto activo visualmente
          document
            .querySelectorAll(".user-item")
            .forEach((el) => el.classList.remove("active"));
          const targetName = lastChat === "Admin" ? currentUser : lastChat;
          const activeUser = [...document.querySelectorAll(".user-item")].find(
            (d) => d.dataset.name === targetName
          );
          if (activeUser) activeUser.classList.add("active");

          // ‚úÖ Volver a colocar el bot√≥n ‚ò∞ en m√≥vil
          ensureMenuIcon();
        };

        // Ejecutar restauraci√≥n despu√©s de 400ms para m√≥viles lentos
        setTimeout(restoreChat, 400);
      });

      // ‚úÖ Mantener la sesi√≥n al recargar, pero borrarla al cerrar la pesta√±a
      let unloadTimer;

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden") {
          // Si despu√©s de 1 segundo la pesta√±a sigue oculta, la consideramos cerrada
          unloadTimer = setTimeout(() => {
            // üßπ Limpiar toda la informaci√≥n temporal (usuario, chat activo, scroll, etc.)
            sessionStorage.clear();
          }, 1000);
        } else {
          clearTimeout(unloadTimer); // Si el usuario vuelve r√°pido (recarga o cambio de pesta√±a), no se borra
        }
      });

      window.login = login;
      window.sendMessage = sendMessage;

      const toggleButton = document.getElementById("toggle-user-list");
      const userList = document.getElementById("user-list");
      const chatHeader = document.getElementById("chat-header");

      // üëÇ Insertar el icono al cargar y al redimensionar
      window.addEventListener("resize", ensureMenuIcon);

      // üëÇ Cada vez que se cambie de chat o se actualice el header, volver a poner el ‚ò∞
      const originalSetText = (text) => {
        chatHeader.textContent = text;
        ensureMenuIcon();
      };

      // üî∏ Sobrescribimos los lugares donde se cambia el encabezado
      window.updateChatHeader = (name) => {
        chatHeader.textContent = name;
        ensureMenuIcon();
      };

      function updateChatHeader(name) {
        const chatHeader = document.getElementById("chat-header");
        chatHeader.textContent = name;
        ensureMenuIcon(); // vuelve a a√±adir el ‚ò∞ si estamos en m√≥vil
      }

      // Luego cambia las l√≠neas como esta:
      document.getElementById(
        "chat-header"
      ).textContent = `${currentUser} (T√∫)`;
      // por esto:
      updateChatHeader(`${currentUser} (T√∫)`);

      // Y esta:
      document.getElementById("chat-header").textContent = `${otherUser}`;
      // por esto:
      updateChatHeader(`${otherUser}`);

      // ‚úÖ Cerrar el men√∫ de contactos autom√°ticamente en m√≥vil al abrir un chat
      function closeMenuOnMobile() {
        if (window.innerWidth <= 768) {
          userList.classList.remove("show");
        }
      }

      // Escuchamos los clics en cada contacto cuando se cargan
      document.addEventListener("click", (e) => {
        const userItem = e.target.closest(".user-item");
        if (userItem) {
          closeMenuOnMobile();
        }
      });
    </script>
  </body>
</html>
